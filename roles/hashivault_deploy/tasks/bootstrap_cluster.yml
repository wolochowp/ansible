---
- name: Gather list of initialized hosts
  delegate_to: localhost
  run_once: true
  ansible.builtin.set_fact:
    hashivault_deploy_initialized_hosts: >-
      {{
        play_hosts
        | map('extract', hostvars, 'hashivault_deploy_initialized')
        | zip(play_hosts)
        | selectattr('0', 'equalto', true)
        | map('last')
        | list
      }}
- name: Set bootstrap allowed flag
  delegate_to: localhost
  run_once: true
  ansible.builtin.set_fact:
    hashivault_deploy_bootstrap_allowed: "{{ hashivault_deploy_initialized_hosts | length == 0 }}"

- name: Show skipping message if cluster already initialized
  delegate_to: localhost
  run_once: true
  ansible.builtin.debug:
    msg: >
      Vault bootstrap skipped because already initialized on hosts:
      {{ hashivault_deploy_initialized_hosts | join(', ') }}
  when: not hashivault_deploy_bootstrap_allowed


# ==========================================================
# Happens only once when have to bootstrap Vault Cluster(e.g. no inited vault nodes yet)
# ==========================================================
- name: Initialize Vault (Shamir) on first node if not initialized and seal is 'none'
  ansible.builtin.command: >
    vault operator init
    -key-shares={{ hashivault_deploy_shamir_key_shares }}
    -key-threshold={{ hashivault_deploy_shamir_key_threshold }}
    -format=json
  register: hashivault_deploy_vault_init
  when:
    - inventory_hostname == play_hosts[0]
    - not hashivault_deploy_initialized
    - hashivault_deploy_bootstrap_allowed
  changed_when: hashivault_deploy_vault_init is changed
  failed_when: hashivault_deploy_vault_init.rc != 0
  environment:
    VAULT_ADDR: "{{ hashivault_deploy_vault_addr }}"
  run_once: true

- name: Save unseal keys and root token to file on controller
  ansible.builtin.copy:
    dest: "{{ hashivault_deploy_secret }}"
    content: "{{ hashivault_deploy_vault_init.stdout }}"
    mode: '0600'
  delegate_to: localhost
  become: true
  run_once: true
  when:
    - inventory_hostname == play_hosts[0]
    - not hashivault_deploy_initialized
    - hashivault_deploy_seal_type == 'none'
    - hashivault_deploy_vault_init is defined
    - hashivault_deploy_bootstrap_allowed
  no_log: true

- name: Get Seal status
  ansible.builtin.include_tasks: check_vault_seal.yml

- name: Unseal leader Vault node
  ansible.builtin.include_tasks: unseal_vault.yml
  when:
    - inventory_hostname == play_hosts[0]
    - hashivault_deploy_bootstrap_allowed or hashivault_deploy_sealed

- name: Join other nodes to Raft cluster
  environment:
    VAULT_ADDR: "{{ hashivault_deploy_vault_addr }}"
  ansible.builtin.command: >
    vault operator raft join {{ hostvars[play_hosts[0]].hashivault_deploy_vault_addr }}
  when:
    - inventory_hostname != play_hosts[0]
    - hashivault_deploy_storage_type == 'raft'
    - hashivault_deploy_bootstrap_allowed
  register: hashivault_deploy_join_result
  changed_when:
    - hashivault_deploy_join_result is changed
    - hashivault_deploy_join_result.rc == 0
